version: "0.29.0"
definitions:
  page_size: 50
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_sentry/schemas/{{ parameters.name }}.json"
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []
  requester:
    type: HttpRequester
    url_base: "https://{{ config.hostname }}/api/0/"
    http_method: "GET"
    authenticator:
      type: "BearerAuthenticator"
      api_token: "{{ config.auth_token }}"
  paginator:
    type: DefaultPaginator
    page_size: "#/definitions/page_size"
    limit_option:
      inject_into: "request_parameter"
      field_name: ""
    page_token_option:
      type: RequestOption
      inject_into: "request_parameter"
      field_name: "cursor"
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{ headers.link.next.cursor }}"
      stop_condition: "{{ headers.link.next.results != 'true' }}"
  retriever:
    type: SimpleRetriever

streams:
  - type: DeclarativeStream
    $parameters:
      # https://docs.sentry.io/api/events/list-a-projects-events/
      name: "events"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
        path: "projects/{{config.organization}}/{{config.project}}/events/"
        request_parameters:
          full: "true"
      paginator:
        $ref: "#/definitions/paginator"
  - type: DeclarativeStream
    $parameters:
      name: "issues"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
        path: "projects/{{config.organization}}/{{config.project}}/issues/"
        request_parameters:
          statsPeriod: ""
          query: ""
      paginator:
        $ref: "#/definitions/paginator"
  - type: DeclarativeStream
    $parameters:
      name: "projects"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
        path: "projects/"
      paginator:
        $ref: "#/definitions/paginator"
  - type: DeclarativeStream
    $parameters:
      name: "project_detail"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
        path: "projects/{{config.organization}}/{{config.project}}/"
      paginator:
        type: NoPagination
check:
  type: CheckStream
  stream_names: ["project_detail"]
spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Sentry Spec
    type: object
    required:
      - auth_token
      - organization
      - project
    additionalProperties: true
    properties:
      auth_token:
        type: string
        title: Authentication Tokens
        description: Log into Sentry and then <a href="https://sentry.io/settings/account/api/auth-tokens/">create authentication tokens</a>.For self-hosted, you can find or create authentication tokens by visiting "{instance_url_prefix}/settings/account/api/auth-tokens/"
        airbyte_secret: true
      hostname:
        type: string
        title: Host Name
        description: Host name of Sentry API server.For self-hosted, specify your host name here. Otherwise, leave it empty.
        default: sentry.io
      organization:
        type: string
        title: Organization
        description: The slug of the organization the groups belong to.
      project:
        type: string
        title: Project
        description: The name (slug) of the Project you want to sync.
      discover_fields:
        type: array
        item: string
        title: Discover Event Fields
        description: Fields to retrieve when fetching discover events
  documentation_url: https://docs.airbyte.com/integrations/sources/sentry
